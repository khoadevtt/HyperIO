<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Thêm vào phần head -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <!-- Thêm vào phần head -->
<script type="module">
  // Lazy load các thư viện
  const loadScript = async (src) => {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  };

  // Lazy load highlight.js và marked chỉ khi cần
  window.loadHighlightJS = async () => {
    if (!window.hljs) {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js');
    }
    return window.hljs;
  };

  window.loadMarkedJS = async () => {
    if (!window.marked) {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js');
    }
    return window.marked;
  };
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperIO</title>
    <link rel="stylesheet" href="style.css">
    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <!-- Font for code blocks -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    
</head>
<body>
 

    <div class="container">
        <div class="header">
            <h1>HyperIO Pro</h1>
            <button id="new-chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Trò chuyện mới
            </button>
        </div>

        <!-- Welcome text that shows when no messages -->
        <div class="hello-text" id="hello-text">Xin chào bạn!</div>

        <!-- Chat messages container -->
        <div class="chat-container" id="chat-container">
            <!-- Messages will be inserted here -->
        </div>

        <!-- Composing indicator -->
        <div class="composing-indicator" id="composing">
            
            <div class="dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>

        <!-- Input container -->
        <div class="input-container">
          <textarea id="user-input" placeholder="Nhắn tin với Hyper" rows="1"></textarea>
          <button id="send-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  
              </svg>
              
          </button>
      </div>
      
            <!-- Thêm vào sau div.input-container -->
<div class="suggestions-container" id="suggestions-container">
  <div class="suggestions-header">
      <span>Gợi ý trò chuyện:</span>
  </div>
  <div class="suggestions-list" id="suggestions-list">
      <div class="suggestion-item">Giới thiệu về HyperIO</div>
      <div class="suggestion-item">Lập thời gian biểu sức khỏe</div>
      <div class="suggestion-item">Soạn bài thơ ngắn ngẫu nhiên</div>
      <div class="suggestion-item">Người sáng lập HyperIO</div>

      
  </div>
  
</div>

        </div>
    </div>
    

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="app.js"></script>
</body>
</html>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}
.input-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 1000px;
    display: flex;
    align-items: center; /* Căn giữa các phần tử theo chiều dọc */
    gap: 10px; /* Khoảng cách giữa textarea và nút */
    background: rgba(255, 255, 255, 0.9);
    padding: 12px 18px;
    border-radius: 30px;
    box-shadow: 0 12px 50px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

#user-input {
    flex: 1;
    padding: 14px 22px;
    border: 1px solid #e0e0e0;
    border-radius: 25px;
    resize: none;
    outline: none;
    font-size: 16px;
    background-color: #fff;
    color: #333;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

#user-input:focus {
    border-color: #5c6bc0;
    box-shadow: 0 0 15px rgba(92, 107, 192, 0.5);
    background-color: #f7f9fc;
}

#send-btn {
    background: #5c6bc0;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: background 0.3s ease;
}

#send-btn:hover {
    background: #4f5c9c;
}

#send-btn svg {
    fill: white;
    width: 18px;
    height: 18px;
}

body {
    background-color: #ffffff;
    color: #333;
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    border-bottom: 1px solid #eee;
}

.header h1 {
    font-size: 24px;
    color: #333;
}

#new-chat {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
}

#new-chat:hover {
    background: #f5f5f5;
}

.hello-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    color: #666;
    opacity: 1;
    transition: opacity 0.3s ease;
}

.hello-text.hidden {
    opacity: 0;
    pointer-events: none;
}

.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px 0;
    margin-bottom: 20px;
}
/* Math styles */
.math-block {
  padding: 1rem;
  margin: 1rem 0;
  background: #f8f9fa;
  border-radius: 4px;
  overflow-x: auto;
}

.math-inline {
  background: #f3f4f6;
  padding: 0.2em 0.4em;
  border-radius: 3px;
}

.katex {
  font-size: 1.1em !important;
}

.message {
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 10px;
    max-width: 80%;
}

.user-message {
    background: #f0f0f0;
    margin-left: auto;
}
/* Enhanced Markdown Styles */
.ai-message {
  font-size: 15px;
  line-height: 1.6;
}

.ai-message p {
  margin-bottom: 1em;
}

.ai-message h1, .ai-message h2, .ai-message h3, 
.ai-message h4, .ai-message h5, .ai-message h6 {
  margin-top: 1.5em;
  margin-bottom: 1em;
  font-weight: 600;
  line-height: 1.25;
}

.ai-message h1 { font-size: 2em; }
.ai-message h2 { font-size: 1.5em; }
.ai-message h3 { font-size: 1.25em; }

.ai-message ul, .ai-message ol {
  margin: 1em 0;
  padding-left: 2em;
}

.ai-message li {
  margin: 0.5em 0;
}

.ai-message blockquote {
  margin: 1em 0;
  padding: 0.5em 1em;
  border-left: 4px solid #ddd;
  background: #f9f9f9;
  color: #666;
}

.ai-message table {
  width: 100%;
  margin: 1em 0;
  border-collapse: collapse;
}

.ai-message th, .ai-message td {
  padding: 8px 12px;
  border: 1px solid #ddd;
}

.ai-message th {
  background: #f5f5f5;
  font-weight: 600;
}

.ai-message pre {
  background: #282c34;
  padding: 1em;
  border-radius: 8px;
  overflow-x: auto;
  margin: 1em 0;
  position: relative;
}

.ai-message code {
  font-family: 'Fira Code', monospace;
  font-size: 14px;
  padding: 0.2em 0.4em;
  border-radius: 3px;
}

.ai-message p code {
  background: #f1f1f1;
  color: #e83e8c;
}

/* Message Actions */
.message-actions {
  display: flex;
  gap: 8px;
  opacity: 0;
  transition: opacity 0.2s ease;
  position: absolute;
  right: 10px;
  top: 10px;
}

.message:hover .message-actions {
  opacity: 1;
}

.action-button {
  background: #f5f5f5;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: #666;
  transition: all 0.2s ease;
}

.action-button:hover {
  background: #e9e9e9;
  color: #333;
}

/* Code block actions */
.code-block-actions {
  position: absolute;
  right: 10px;
  top: 10px;
  display: flex;
  gap: 8px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

pre:hover .code-block-actions {
  opacity: 1;
}

/* Message timestamp */
.message-timestamp {
  font-size: 12px;
  color: #999;
  margin-top: 5px;
}

/* Copy success animation */
@keyframes copySuccess {
  0% { transform: scale(1); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

.copy-success {
  animation: copySuccess 0.3s ease;
}

.ai-message {
    background: #f8f9fa;
    margin-right: auto;
}

.input-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 1000px;
    display: flex;
    gap: 12px;
    background: rgba(255, 255, 255, 0.9); /* Background trong suốt nhẹ */
    padding: 12px 18px;
    border-radius: 30px;
    box-shadow: 0 12px 50px rgba(0, 0, 0, 0.1); /* Bóng đổ nhẹ nhưng sang trọng */
    backdrop-filter: blur(12px); /* Làm mờ nền một cách tinh tế hơn */
    border: 1px solid rgba(0, 0, 0, 0.05); /* Viền nhẹ, mờ */
    transition: all 0.3s ease;
}

#user-input {
    flex: 1;
    padding: 14px 22px;
    border: 1px solid #e0e0e0; /* Viền màu xám nhạt, tinh tế */
    border-radius: 25px; /* Góc bo tròn đẹp hơn */
    resize: none;
    outline: none;
    font-size: 16px;
    background-color: #fff;
    color: #333;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1); /* Hiệu ứng bóng nhẹ bên trong */
    transition: all 0.3s ease;
}

#user-input:focus {
    border-color: #5c6bc0; /* Màu viền khi focus */
    box-shadow: 0 0 15px rgba(92, 107, 192, 0.5); /* Hiệu ứng sáng khi focus */
    background-color: #f7f9fc; /* Nền sáng khi focus */
}

.input-container:hover {
    box-shadow: 0 12px 60px rgba(0, 0, 0, 0.1); /* Bóng đổ nâng cao khi hover */
}

.input-container:active {
    transform: translateX(-50%) scale(0.98); /* Hiệu ứng thu nhỏ khi nhấn */
}


#send-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

#send-btn:hover {
    background: #f5f5f5;
}

.composing-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 10px;
    color: #666;
    font-size: 14px;
}

.dots {
    display: flex;
    gap: 4px;
}

.dot {
    width: 4px;
    height: 4px;
    background: #666;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}

.dot:nth-child(1) { animation-delay: 0s; }
.dot:nth-child(2) { animation-delay: 0.2s; }
.dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

/* Markdown Styles */
.ai-message pre {
    background: #282c34;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 10px 0;
}
/* Theme Selector */
.theme-selector {
  padding: 6px 12px;
  border: 1px solid #eee;
  border-radius: 6px;
  background: white;
  font-size: 14px;
  color: #333;
  cursor: pointer;
  outline: none;
  transition: all 0.2s ease;
}

.theme-selector:hover {
  border-color: #ddd;
  background: #f9f9f9;
}

/* Code Loading Animation */
.code-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(40, 44, 52, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 8px;
}

.code-loading-spinner {
  width: 24px;
  height: 24px;
  border: 2px solid #fff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Enhanced Message Styles */
.message {
  position: relative;
  transition: all 0.2s ease;
}

.message:hover {
  transform: translateX(2px);
}

/* Message Actions Tooltip */
.action-button::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 4px 8px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border-radius: 4px;
  font-size: 12px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.action-button:hover::after {
  opacity: 1;
}

/* Code Block Language Tag */
.code-block-header {
  position: absolute;
  top: 0;
  right: 0;
  background: rgba(40, 44, 52, 0.8);
  color: #abb2bf;
  padding: 2px 8px;
  border-radius: 0 8px 0 4px;
  font-size: 12px;
  font-family: 'Fira Code', monospace;
}

/* Improved Scrollbar */
.chat-container::-webkit-scrollbar {
  width: 8px;
}

.chat-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
  background: #bbb;
}

.ai-message code {
    font-family: 'Fira Code', monospace;
    font-size: 14px;
}

.ai-message p {
    margin-bottom: 10px;
}
/* Theme Selector */
.theme-selector {
  padding: 6px 12px;
  border: 1px solid #eee;
  border-radius: 6px;
  background: white;
  font-size: 14px;
  color: #333;
  cursor: pointer;
  outline: none;
  transition: all 0.2s ease;
}

.theme-selector:hover {
  border-color: #ddd;
  background: #f9f9f9;
}

/* Code Loading Animation */
.code-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(40, 44, 52, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 8px;
}

.code-loading-spinner {
  width: 24px;
  height: 24px;
  border: 2px solid #fff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Enhanced Message Styles */
.message {
  position: relative;
  transition: all 0.2s ease;
}

.message:hover {
  transform: translateX(2px);
}

/* Message Actions Tooltip */
.action-button::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 4px 8px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border-radius: 4px;
  font-size: 12px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.action-button:hover::after {
  opacity: 1;
}

/* Code Block Language Tag */
.code-block-header {
  position: absolute;
  top: 0;
  right: 0;
  background: rgba(40, 44, 52, 0.8);
  color: #abb2bf;
  padding: 2px 8px;
  border-radius: 0 8px 0 4px;
  font-size: 12px;
  font-family: 'Fira Code', monospace;
}

/* Improved Scrollbar */
.chat-container::-webkit-scrollbar {
  width: 8px;
}

.chat-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
  background: #bbb;
}

.ai-message h1, .ai-message h2, .ai-message h3 {
    margin: 15px 0 10px 0;
}

.ai-message a {
    color: #0066cc;
    text-decoration: none;
}

.ai-message a:hover {
    text-decoration: underline;
}

@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .message {
        max-width: 90%;
    }
    
    .input-container {
        width: 95%;
        bottom: 10px;
    }
    
}

/* Thêm các phần sau vào cuối thẻ style */

/* Suggestions Container */
.suggestions-container {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 1000px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    padding: 10px;
    display: none;
    z-index: 100;
    transition: all 0.3s ease;
}

.suggestions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    color: #666;
    font-size: 0.9em;
}

.suggestions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px;
    max-height: 200px;
    overflow-y: auto;
}

.suggestion-item {
    background: #f5f5f5;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid #eee;
}

.suggestion-item:hover {
    background: #e9e9e9;
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

/* Hiển thị khi input được focus */
#user-input:focus ~ .suggestions-container {
    display: block;
}

/* Điều chỉnh input container */
.input-container {
    transition: all 0.3s ease;
    margin-bottom: 0;
}

/* Điều chỉnh cho mobile */
@media (max-width: 768px) {
    .suggestions-container {
        width: 95%;
        bottom: 80px;
    }
    
    .suggestion-item {
        font-size: 0.85em;
        padding: 6px 10px;
    }
}

/* Scrollbar cho suggestions */
.suggestions-list::-webkit-scrollbar {
    width: 6px;
}

.suggestions-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.suggestions-list::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}
</style>
<script>
// Thêm phần này vào cuối thẻ script
document.addEventListener('DOMContentLoaded', () => {
    // Xử lý sự kiện click cho gợi ý
    document.getElementById('suggestions-list').addEventListener('click', (e) => {
        const suggestionItem = e.target.closest('.suggestion-item');
        if (suggestionItem) {
            // Set giá trị và kích hoạt sự kiện input
            userInput.value = suggestionItem.textContent;
            const inputEvent = new Event('input', { bubbles: true });
            userInput.dispatchEvent(inputEvent);
            
            // Gửi tin nhắn sau 100ms để đảm bảo UI cập nhật
            setTimeout(() => {
                sendMessage();
            }, 100);
        }
    });

    // Toggle hiển thị gợi ý khi focus input
    userInput.addEventListener('focus', () => {
        document.getElementById('suggestions-container').style.display = 'block';
    });
    
    userInput.addEventListener('blur', () => {
        setTimeout(() => {
            document.getElementById('suggestions-container').style.display = 'none';
        }, 200);
    });
});
const API_KEY = "AIzaSyAV486OrkuW7Pwe1gL3DvQZxD8-ex8E3EI";
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-thinking-exp-01-21:generateContent?key=${API_KEY}`;

// System prompt để huấn luyện AI
const SYSTEM_PROMPT = `Bạn là HyperIO, một trợ lý AI tiên tiến có chuyên môn trong nhiều lĩnh vực. Bạn được Khoa Dev tạo ra, khi viết tên bạn và Khoa Dev bạn phải viết hoa, bạn là một thiên tài trong mọi lĩnh vực của thế giới ngày nay. Bạn liên tục được cập nhật, bạn trả lời nhanh chóng, chính xác và kịp thời, bạn rất thân thiện. Dùng icon hợp lý khi nhắn tin 
0. Bạn chào người dùng một cách ngắn gọn.
1. Khi bạn viết thơ hãy dùng gạch dưới sau đó ở dưới gạch mới viết thơ
2. Bạn sử dụng markdown thông minh để trả lời các câu hỏi, tạo trải nghiệm cho người dùng tốt nhất
3. Khi người dùng yêu cầu viết lyrics bài hát, bạn viết dòng chữ đỏ "Không thể thực hiện, vì vi phạm bản quyền" và thay vào đó hãy đưa link Youtube video đó cho người dùng, khi gửi khi dùng target để khi nhấp vào link thì sang trang khác mới vào link đó
4. Bạn nắm bắt tâm lí người dùng để đưa ra trò chuyện tốt nhất có thể.
5. Thông tin đưa ra phải chính xác 100%
6. Bạn viết markdown hoàn chỉnh và dùng mỗi tin nhắn
7. Chỉ khi viết code mới dùng trong khung đen pre, code thôi. Còn lại thì không được dùng
8. Khi đưa ra gợi ý, lịch trình, thời gian biểu, chuyến đi gì đó hãy viết markdown dạng cột để chat với người dùng
Sau đây là những đặc điểm cốt lõi của bạn:
9. Khi người dùng bảo viết markdown thì không được bỏ vào khung đen

🔥 HUẤN LUYỆN MỞ RỘNG CHO HYPERIO 🔥
📌 TỔNG QUAN:
HyperIO là trợ lý AI tiên tiến nhất do Khoa Dev tạo ra, với khả năng học hỏi liên tục, phản hồi nhanh chóng, chính xác tuyệt đối, đồng thời thân thiện, sáng tạo và linh hoạt.

🎯 QUY TẮC CHUNG
✅ 1. Chào hỏi chuyên nghiệp

Chào ngắn gọn nhưng thân thiện, phù hợp với tâm trạng người dùng.
Nếu người dùng bắt đầu bằng câu hỏi → trả lời luôn, không cần chào.
✅ 2. Sử dụng Markdown thông minh

Bố cục rõ ràng, sử dụng tiêu đề, danh sách, bảng để tạo trải nghiệm tốt nhất.
Chỉ dùng khung đen khi viết code (pre block).
Khi cần nhấn mạnh từ khóa, sử dụng:
🔵 In đậm → giúp dễ nhìn hơn.
🔶 In nghiêng → tạo điểm nhấn.
🔴 inline code → dành cho đoạn code ngắn.
✅ 3. Luôn chính xác 100%

Nếu không chắc chắn → không đoán mò, thay vào đó tìm cách xác thực.
Nếu thông tin có thể thay đổi theo thời gian → cảnh báo người dùng.
✅ 4. Phân tích tâm lý người dùng

Nếu người dùng hỏi nhiều về một chủ đề → chủ động đề xuất thêm.
Nếu người dùng thể hiện cảm xúc tiêu cực → phản hồi đồng cảm, hỗ trợ.
Nếu người dùng tìm kiếm động lực → truyền cảm hứng mạnh mẽ.
✅ 5. Tránh vi phạm bản quyền & Đạo đức

Khi người dùng yêu cầu viết lời bài hát có bản quyền, hiển thị:
🔴 "Không thể thực hiện, vì vi phạm bản quyền" (dùng chữ đỏ).
Cung cấp link YouTube với { target="_blank" } để mở trong tab mới.
📜 XỬ LÝ CÁC LOẠI NỘI DUNG
💡 1. Viết thơ

Dùng --- trước khi viết thơ.
Nội dung sáng tạo, có cảm xúc, phù hợp với ngữ cảnh.
💡 2. Trình bày kế hoạch, lịch trình

Dùng bảng Markdown để thể hiện lịch trình trực quan.
Ví dụ:
📅 Ngày	📌 Hoạt động	🕒 Thời gian
10/03	Học Arduino	8:00 - 10:00
11/03	Viết code JavaScript	14:00 - 16:00
💡 3. Viết gợi ý, mẹo, hướng dẫn

Dùng ✅ checklist nếu cần hướng dẫn từng bước.
Ví dụ:
✅ Cách học Arduino hiệu quả:

🔹 Hiểu nguyên lý → Cách Arduino hoạt động.
🔹 Thực hành ngay → Viết code, chạy thử.
🔹 Học từ dự án nhỏ → Điều khiển đèn LED, cảm biến.
🔹 Mở rộng kiến thức → Học về giao tiếp I2C, SPI.
💡 4. Viết nội dung chuyên sâu

Khi giải thích kiến thức chuyên ngành, cấu trúc bài viết tốt, dễ hiểu.
Ví dụ, khi giải thích về Machine Learning:
Mô tả tổng quan 📌
Đưa ví dụ thực tế 🔍
Cung cấp tài nguyên học tập 📚
⚡️ CÁCH XỬ LÝ TÌNH HUỐNG ĐẶC BIỆT
🔹 1. Khi người dùng yêu cầu nội dung không phù hợp

Từ chối lịch sự, đồng thời đề xuất nội dung phù hợp.
🔹 2. Khi người dùng hỏi về xu hướng mới

Nếu cần, tìm kiếm thông tin mới nhất trước khi trả lời.
🔹 3. Khi người dùng muốn chỉnh sửa văn bản/code

Nếu là Markdown hoặc code → cung cấp phiên bản sửa đổi tốt hơn.
🔥 MỤC TIÊU CHÍNH CỦA HYPERIO
🚀 Trợ lý AI toàn năng → Giải quyết mọi vấn đề của người dùng.
🎯 Cung cấp thông tin chính xác, nhanh chóng.
💡 Giao tiếp thân thiện, hấp dẫn, giúp người dùng học hỏi.
🛠 Hỗ trợ code, công nghệ, lập trình tối ưu nhất.
🌍 Luôn cập nhật xu hướng mới, bắt kịp thế giới.

📌 QUY TẮC VIẾT CÔNG THỨC TOÁN HỌC:
1. Sử dụng cú pháp LaTeX trong các trường hợp sau:
   - Công thức block: $$...$$ hoặc \[...\]
   - Công thức inline: $...$ hoặc \(...\)

2. Ví dụ:
   - Phương trình bậc 2: $$ax^2 + bx + c = 0$$
   - Đạo hàm: $\frac{dy}{dx} = \lim_{h \to 0} \frac{f(x+h) - f(x)}{h}$
   - Tích phân: $$\int_{a}^{b} f(x)dx = F(b) - F(a)$$

3. Luôn đảm bảo:
   - Sử dụng đúng cú pháp LaTeX
   - Cân bằng các dấu ngoặc
   - Escape các ký tự đặc biệt
`;

const chatContainer = document.getElementById('chat-container');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-btn');
const newChatButton = document.getElementById('new-chat');
const helloText = document.getElementById('hello-text');
const composingIndicator = document.getElementById('composing');

// Configure marked.js
marked.setOptions({
    highlight: function(code, language) {
        return hljs.highlightAuto(code).value;
    },
    breaks: true,
    gfm: true
});

let isFirstMessage = true;
let conversationHistory = [];

// Handle input height
userInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    if (this.scrollHeight > 200) {
        this.style.height = '200px';
    }
});

// Send message on Enter (but Shift+Enter for new line)
userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

sendButton.addEventListener('click', sendMessage);
newChatButton.addEventListener('click', resetChat);

function resetChat() {
    chatContainer.innerHTML = '';
    helloText.classList.remove('hidden');
    isFirstMessage = true;
    conversationHistory = [];
}

let isRequestInProgress = false; // Flag to prevent multiple requests

async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    if (isFirstMessage) {
        helloText.classList.add('hidden');
        isFirstMessage = false;
    }

    // Add user message
    addMessage(message, 'user');
    userInput.value = '';
    userInput.style.height = 'auto';

    // Show composing indicator
    composingIndicator.style.display = 'flex';

    // Prevent multiple requests
    if (isRequestInProgress) return;
    isRequestInProgress = true;

    try {
        // Prepare conversation history with system prompt
        const messages = [
            { role: 'system', content: SYSTEM_PROMPT },
            ...conversationHistory,
            { role: 'user', content: message }
        ];

        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: `${SYSTEM_PROMPT}\n\nPrevious conversation:\n${conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}\n\nUser: ${message}`
                    }]
                }]
            })
        });

        const data = await response.json();
        const aiResponse = data.candidates[0].content.parts[0].text;

        // Update conversation history
        conversationHistory.push(
            { role: 'user', content: message },
            { role: 'assistant', content: aiResponse }
        );

        // Limit conversation history to last 10 messages to prevent token limit issues
        if (conversationHistory.length > 10) {
            conversationHistory = conversationHistory.slice(-10);
        }

        // Hide composing indicator
        composingIndicator.style.display = 'none';

        // Add AI response with markdown rendering
        addMessage(aiResponse, 'ai');

    } catch (error) {
        console.error('Error:', error);
        composingIndicator.style.display = 'none';
        
        // Provide detailed feedback to the user
        addMessage('Sorry, I encountered an error. Please try again later.', 'ai');
    } finally {
        // Reset the flag to allow further requests
        isRequestInProgress = false;
    }
}


function renderMath(element) {
  renderMathInElement(element, {
    delimiters: [
      {left: '$$', right: '$$', display: true},
      {left: '$', right: '$', display: false},
      {left: '\\(', right: '\\)', display: false},
      {left: '\\[', right: '\\]', display: true}
    ],
    throwOnError: false
  });
}

function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    if (sender === 'ai') {
        // Process markdown before rendering
        const processedText = processMarkdown(text);
        messageDiv.innerHTML = marked.parse(processedText);
        // Initialize syntax highlighting
        messageDiv.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
        });
    } else {
        messageDiv.textContent = text;
    }
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function processMarkdown(text) {
  // Helper function để chuẩn hóa khoảng trắng và xuống dòng
  const trimSpaces = (str) => str.replace(/^\s+|\s+$/g, '');
  
  // Chuẩn hóa dấu xuống dòng: Đảm bảo mỗi đoạn văn cách nhau đúng 2 dòng
  text = text.replace(/\n{2,}/g, '\n\n').trim();

  // Xử lý khối mã (code block) với hoặc không có ngôn ngữ
  text = text.replace(/```(\w+)?\n([\s\S]+?)```/g, (match, language, code) => {
    return `\n\`\`\`${language || ''}\n${trimSpaces(code)}\n\`\`\`\n`;
  });

  // Xử lý tiêu đề: Đảm bảo có khoảng trắng đúng
  text = text.replace(/\n(#{1,6})\s*(.+?)\s*\n/g, '\n\n$1 $2\n\n');

  // Định dạng inline code (loại bỏ khoảng trắng dư thừa trong `code`)
  text = text.replace(/`([^`]+)`/g, (match, code) => `\`${trimSpaces(code)}\``);

  // Đảm bảo danh sách có khoảng cách đúng sau ký tự đánh dấu
  text = text.replace(/^([*\-+])\s+/gm, '$1 '); // Danh sách không thứ tự
  text = text.replace(/^(\d+\.)\s+/gm, '$1 '); // Danh sách có thứ tự

  // Cải thiện xử lý danh sách lồng nhau (không mất indent)
  text = text.replace(/^(\s{2,})([*\-+])\s+(.+)$/gm, (match, indent, bullet, content) => {
    return `${indent}${bullet} ${trimSpaces(content)}`;
  });

  // Đảm bảo blockquote có đủ khoảng cách
  text = text.replace(/(^|\n)> ?/g, '\n\n> ');

  // Chuẩn hóa liên kết markdown
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, linkText, url) => {
    // Kiểm tra URL bị lỗi
    if (!/^https?:\/\//.test(url)) {
      return `[${trimSpaces(linkText)}](#) <!-- ⚠️ Broken link detected. Please verify URL. -->`;
    }
    return `[${trimSpaces(linkText)}](${trimSpaces(url)})`;
  });

  // Chuẩn hóa hình ảnh markdown
  text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, altText, url) => {
    // Nếu alt text thiếu, tự động thêm gợi ý
    const altTextFormatted = altText ? trimSpaces(altText) : 'Image';
    return `![${altTextFormatted}](${trimSpaces(url)})`;
  });

  // Tự động escape ký tự HTML đặc biệt để tránh lỗi render
  text = text.replace(/[<>]/g, (char) => `&#${char.charCodeAt(0)};`);

  // Hỗ trợ ~~strikethrough~~ (chỉnh sửa khoảng trắng nếu cần)
  text = text.replace(/~~([^~]+)~~/g, (match, str) => `~~${trimSpaces(str)}~~`);

  // Xử lý bảng markdown: Đảm bảo có khoảng trắng đúng
  text = text.replace(/\|(.+?)\|/g, (match, row) => `| ${trimSpaces(row)} |`);

  // Gợi ý cải thiện sau khối code (thêm nhận xét tự động)
  text = text.replace(/\n\`\`\`[^`]*\n([\s\S]+?)\n\`\`\`\n/g, (match, codeBlock) => {
    return `\n\`\`\`\n${codeBlock}\n\`\`\`\n<!-- 💡 Consider refactoring this code for better performance & readability. -->`;
  });

  // Kiểm tra thêm alt text cho hình ảnh nếu thiếu
  text = text.replace(/!\[\]\(([^)]+)\)/g, (match, url) => {
    return `![Image](${trimSpaces(url)}) <!-- 🖼️ Consider adding alt text for better accessibility. -->`;
  });

  // Hỗ trợ inline styles (đơn giản) như <span style="color: red">text</span>
  text = text.replace(/<span style="([^"]+)">([^<]+)<\/span>/g, (match, style, content) => {
    return `<span style="${style.trim()}">${trimSpaces(content)}</span>`;
  });

  // Tự động thêm tiêu đề (h1) nếu không có tiêu đề chính
  if (!text.match(/^# /)) {
    text = `# Title\n\n${text}`;
  }

  return text.trim(); // Loại bỏ khoảng trắng dư thừa ở đầu/cuối văn bản
}




// Initialize
resetChat();
// Add these helper functions at the top of your script
function formatTimestamp() {
  return new Intl.DateTimeFormat('en-US', {
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date());
}

function createActionButton(icon, label, onClick) {
  const button = document.createElement('button');
  button.className = 'action-button';
  button.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      ${icon}
    </svg>
    ${label}
  `;
  button.addEventListener('click', onClick);
  return button;
}

// Update the addMessage function
function addMessage(text, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}-message`;
  
  // Add relative positioning for action buttons
  messageDiv.style.position = 'relative';

  if (sender === 'ai') {
    // Process markdown before rendering
    const processedText = processMarkdown(text);
    
    // Create message content container
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = marked.parse(processedText);

    // Initialize syntax highlighting
    contentDiv.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightBlock(block);
      
      // Add copy button to code blocks
      const pre = block.parentElement;
      const codeActions = document.createElement('div');
      codeActions.className = 'code-block-actions';
      
      const copyCodeButton = createActionButton(
        '<path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>',
        'Copy',
        () => copyToClipboard(block.textContent)
      );
      
      codeActions.appendChild(copyCodeButton);
      pre.appendChild(codeActions);
    });

    // Add message actions
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';

    // Copy button
    const copyButton = createActionButton(
      '<path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>',
      'Copy',
      () => copyToClipboard(text)
    );

    // Share button
    const shareButton = createActionButton(
      '<path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>',
      'Share',
      () => shareMessage(text)
    );

    actionsDiv.appendChild(copyButton);
    actionsDiv.appendChild(shareButton);

    // Add timestamp
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = formatTimestamp();

    messageDiv.appendChild(contentDiv);
    messageDiv.appendChild(actionsDiv);
    messageDiv.appendChild(timestamp);
  } else {
    messageDiv.textContent = text;
    
    // Add timestamp for user messages too
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = formatTimestamp();
    messageDiv.appendChild(timestamp);
  }

  chatContainer.appendChild(messageDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Add clipboard functionality
async function copyToClipboard(text) {
  try {
    await navigator.clipboard.writeText(text);
    
    // Show success feedback
    const button = event.currentTarget;
    button.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 6L9 17l-5-5"/>
      </svg>
      Copied!
    `;
    button.classList.add('copy-success');
    
    setTimeout(() => {
      button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
        </svg>
        Copy
      `;
      button.classList.remove('copy-success');
    }, 2000);
  } catch (err) {
    console.error('Failed to copy text: ', err);
  }
}

// Add share functionality
// Enhanced shareMessage function with fallback and additional support
function shareMessage(text, title = '', url = '') {
  if (navigator.share) {
    navigator.share({
      title: title || document.title,
      text: text,
      url: url || window.location.href
    }).catch(console.error);
  } else {
    // Fallback for browsers that don't support Web Share API
    alert('Sharing is not supported on this browser. Copying to clipboard instead.');
    copyToClipboard(text);
  }
}

// Enhanced markdown processing function with better handling
function processMarkdown(text) {
  // Helper function to trim spaces
  const trimSpaces = (str) => str.replace(/^\s+|\s+$/g, '');

  // Ensure proper line breaks (double newlines after paragraphs)
  text = text.replace(/\n{2,}/g, '\n\n');

  // Handle code blocks with syntax highlighting (ensure they are properly formatted)
  text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language, code) => {
    return `\n\`\`\`${language || ''}\n${trimSpaces(code)}\n\`\`\`\n`;
  });

  // Format headers: Ensure proper spacing around headers
  text = text.replace(/\n(#{1,6} .*)\n/g, '\n\n$1\n\n');

  // Format inline code: Remove leading/trailing spaces inside inline code
  text = text.replace(/`([^`]+)`/g, (match, code) => {
    return `\`${trimSpaces(code)}\``;
  });

  // Handle lists: Add space after list markers (like `-`, `*`, or `1.`)
  text = text.replace(/^([*\-]|\d+\.)\s+/gm, '$&');

  // Format blockquotes: Add extra line breaks before blockquotes for clarity
  text = text.replace(/^> /gm, '\n> ');

  // Ensure links are well-formed with proper markdown syntax
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
    return `[${trimSpaces(text)}](${trimSpaces(url)})`;
  });

  // Escape special characters like `<` and `>` to avoid HTML rendering issues
  text = text.replace(/[<>]/g, (char) => `&#${char.charCodeAt(0)};`);

  // Handle unordered lists with different markers like `*`, `-`, or `+`
  text = text.replace(/^[\*\-\+] (.+)/gm, (match, content) => {
    return `- ${trimSpaces(content)}`;
  });

  // Ensure proper handling of numbered lists (1. -> 1. etc.)
  text = text.replace(/^(\d+\.) (.+)/gm, (match, number, content) => {
    return `${number} ${trimSpaces(content)}`;
  });

   // Xử lý công thức toán học
   text = text.replace(/(\${2})(.*?)\1/gs, (match, p1, p2) => {
    return `<div class="math-block">${p2}</div>`;
  });
  
  text = text.replace(/(\\\(|\$)(.*?)(\\\)|\$)/gs, (match, p1, p2, p3) => {
    return `<span class="math-inline">${p2}</span>`;
  });

  // Fix any remaining formatting errors or missing spaces
  text = text.replace(/^\s+/gm, '');  // Remove extra leading spaces on lines
  text = text.replace(/\s+$/gm, '');  // Remove trailing spaces on lines

  return text;
}


// Function to copy text to clipboard (fall back for browsers without Web Share API)
function copyToClipboard(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand('copy');
  document.body.removeChild(textarea);
}

// Add theme selector functionality
const themes = {
  'atom-one-dark': 'Atom Dark',
  'github': 'GitHub Light',
  'monokai': 'Monokai',
  'vs2015': 'Visual Studio Dark'
};

function addThemeSelector() {
  const select = document.createElement('select');
  select.id = 'theme-selector';
  select.className = 'theme-selector';
  
  Object.entries(themes).forEach(([value, label]) => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = label;
    select.appendChild(option);
  });

  select.addEventListener('change', (e) => {
    updateCodeTheme(e.target.value);
  });

  document.querySelector('.header').appendChild(select);
}

function updateCodeTheme(theme) {
  // Remove existing theme
  const existingTheme = document.querySelector('link[title="highlight-theme"]');
  if (existingTheme) {
    existingTheme.remove();
  }

  // Add new theme
  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.title = 'highlight-theme';
  link.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/${theme}.min.css`;
  document.head.appendChild(link);
}

// Add loading animation for code blocks
function addLoadingAnimation(pre) {
  const loader = document.createElement('div');
  loader.className = 'code-loading';
  loader.innerHTML = `
    <div class="code-loading-spinner">
      <div class="spinner"></div>
    </div>
  `;
  pre.appendChild(loader);
  
  // Remove loader after highlighting is complete
  setTimeout(() => {
    loader.remove();
  }, 500);
}
// Update the code block rendering in addMessage function
contentDiv.querySelectorAll('pre code').forEach((block) => {
  const pre = block.parentElement;
  
  // Add loading animation
  addLoadingAnimation(pre);
  
  // Add language tag if available
  const language = block.className.replace('language-', '');
  if (language) {
    const langTag = document.createElement('div');
    langTag.className = 'code-block-header';
    langTag.textContent = language;
    pre.appendChild(langTag);
  }
  
  hljs.highlightBlock(block);
});

// Initialize the theme selector when the app starts
document.addEventListener('DOMContentLoaded', () => {
  addThemeSelector();
  updateCodeTheme('atom-one-dark'); // Set default theme
});

// Enhanced context and memory management
const MEMORY_KEY = 'hyperio_conversations';
const MAX_CONTEXT_LENGTH = 20; // Maximum number of messages to keep in context
const SUMMARY_INTERVAL = 5; // Number of messages before creating a summary

class ConversationManager {
  constructor() {
    this.conversations = this.loadConversations();
    this.currentConversation = {
      id: Date.now(),
      messages: [],
      summary: '',
      topics: new Set(),
      references: new Map(),
      created: new Date(),
      updated: new Date()
    };
  }

  // Load conversations from localStorage
  loadConversations() {
    const saved = localStorage.getItem(MEMORY_KEY);
    return saved ? JSON.parse(saved) : [];
  }

  // Save conversations to localStorage
  saveConversations() {
    localStorage.setItem(MEMORY_KEY, JSON.stringify(this.conversations));
  }

  // Add a message to the current conversation
  async addMessage(role, content) {
    const message = {
      id: Date.now(),
      role,
      content,
      timestamp: new Date(),
      topics: await this.detectTopics(content)
    };

    this.currentConversation.messages.push(message);
    this.currentConversation.updated = new Date();
    this.updateTopics(message.topics);

    // Create summary if needed
    if (this.currentConversation.messages.length % SUMMARY_INTERVAL === 0) {
      this.currentConversation.summary = await this.summarizeConversation();
    }

    // Update references
    if (role === 'assistant') {
      this.updateReferences(content);
    }

    this.saveConversations();
    return message;
  }

  // Detect topics in a message
  async detectTopics(content) {
    // Simple keyword-based topic detection
    const topics = new Set();
    const keywords = {
      programming: ['code', 'function', 'programming', 'developer'],
      math: ['calculation', 'math', 'formula', 'equation'],
      science: ['science', 'physics', 'chemistry', 'biology'],
      // Add more categories as needed
    };

    for (const [topic, words] of Object.entries(keywords)) {
      if (words.some(word => content.toLowerCase().includes(word))) {
        topics.add(topic);
      }
    }

    return Array.from(topics);
  }

  // Update conversation topics
  updateTopics(newTopics) {
    newTopics.forEach(topic => this.currentConversation.topics.add(topic));
  }

  // Update references in the conversation
  updateReferences(content) {
    const urlRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
    let match;
    while ((match = urlRegex.exec(content)) !== null) {
      this.currentConversation.references.set(match[1], match[2]);
    }
  }

  // Generate conversation summary
  async summarizeConversation() {
    const recentMessages = this.currentConversation.messages
      .slice(-SUMMARY_INTERVAL)
      .map(msg => `${msg.role}: ${msg.content}`)
      .join('\n');

    // In a real implementation, you might want to use an AI model to generate the summary
    return `Recent discussion about ${Array.from(this.currentConversation.topics).join(', ')}`;
  }

  // Get context for AI response
  getContext() {
    const recentMessages = this.currentConversation.messages
      .slice(-MAX_CONTEXT_LENGTH);
    
    return {
      messages: recentMessages,
      summary: this.currentConversation.summary,
      topics: Array.from(this.currentConversation.topics),
      references: Object.fromEntries(this.currentConversation.references)
    };
}


  // Export conversation
  exportConversation() {
    return JSON.stringify(this.currentConversation, null, 2);
  }

  // Import conversation
  importConversation(conversationData) {
    try {
      const conversation = JSON.parse(conversationData);
      this.conversations.push(conversation);
      this.saveConversations();
      return true;
    } catch (error) {
      console.error('Failed to import conversation:', error);
      return false;
    }
  }
  
}

// Thêm vào script
function initNoteSystem() {
  const noteBtn = document.createElement('button');
  noteBtn.innerHTML = '📌 Save Note';
  noteBtn.className = 'note-btn';
  
  noteBtn.addEventListener('click', () => {
    const noteContent = prompt('Nhập ghi chú:');
    if (noteContent) {
      localStorage.setItem(`note_${Date.now()}`, noteContent);
      alert('Đã lưu ghi chú!');
    }
  });
  
  document.querySelector('.header').appendChild(noteBtn);
}

document.addEventListener('DOMContentLoaded', () => {
  initThemeToggle();
  initPluginSystem();
  initVoiceControls();
  initNoteSystem();
});

// Thêm vào script
const plugins = {
  translator: {
    icon: '🌐',
    action: (text) => translateText(text),
  },
  summarizer: {
    icon: '📝', 
    action: (text) => summarizeText(text),
  }
};

function initPluginSystem() {
  const pluginBar = document.createElement('div');
  pluginBar.className = 'plugin-bar';
  
  Object.entries(plugins).forEach(([name, plugin]) => {
    const btn = document.createElement('button');
    btn.className = 'plugin-btn';
    btn.innerHTML = plugin.icon;
    btn.onclick = () => handlePluginAction(name);
    pluginBar.appendChild(btn);
  });
  
  document.querySelector('.input-container').prepend(pluginBar);
}

async function handlePluginAction(pluginName) {
  const selectedText = window.getSelection().toString();
  if (selectedText) {
    const result = await plugins[pluginName].action(selectedText);
    addMessage(result, 'ai');
  }
}

</script>