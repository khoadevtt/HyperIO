<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Th√™m v√†o ph·∫ßn head -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <!-- Th√™m v√†o ph·∫ßn head -->
<script type="module">
  // Lazy load c√°c th∆∞ vi·ªán
  const loadScript = async (src) => {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  };

  // Lazy load highlight.js v√† marked ch·ªâ khi c·∫ßn
  window.loadHighlightJS = async () => {
    if (!window.hljs) {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js');
    }
    return window.hljs;
  };

  window.loadMarkedJS = async () => {
    if (!window.marked) {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js');
    }
    return window.marked;
  };
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperIO</title>
    <link rel="stylesheet" href="style.css">
    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <!-- Font for code blocks -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    
</head>
<body>
 

    <div class="container">
        <div class="header">
            <h1>HyperIO Pro</h1>
            <button id="new-chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Tr√≤ chuy·ªán m·ªõi
            </button>
        </div>

        <!-- Welcome text that shows when no messages -->
        <div class="hello-text" id="hello-text">Xin ch√†o b·∫°n!</div>

        <!-- Chat messages container -->
        <div class="chat-container" id="chat-container">
            <!-- Messages will be inserted here -->
        </div>

        <!-- Composing indicator -->
        <div class="composing-indicator" id="composing">
            
            <div class="dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>

        <!-- Input container -->
        <div class="input-container">
          <textarea id="user-input" placeholder="Nh·∫Øn tin v·ªõi Hyper" rows="1"></textarea>
          <button id="send-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  
              </svg>
              
          </button>
      </div>
      
            <!-- Th√™m v√†o sau div.input-container -->
<div class="suggestions-container" id="suggestions-container">
  <div class="suggestions-header">
      <span>G·ª£i √Ω tr√≤ chuy·ªán:</span>
  </div>
  <div class="suggestions-list" id="suggestions-list">
      <div class="suggestion-item">Gi·ªõi thi·ªáu v·ªÅ HyperIO</div>
      <div class="suggestion-item">L·∫≠p th·ªùi gian bi·ªÉu s·ª©c kh·ªèe</div>
      <div class="suggestion-item">So·∫°n b√†i th∆° ng·∫Øn ng·∫´u nhi√™n</div>
      <div class="suggestion-item">Ng∆∞·ªùi s√°ng l·∫≠p HyperIO</div>

      
  </div>
  
</div>

        </div>
    </div>
    

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="app.js"></script>
</body>
</html>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}
.input-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 1000px;
    display: flex;
    align-items: center; /* CƒÉn gi·ªØa c√°c ph·∫ßn t·ª≠ theo chi·ªÅu d·ªçc */
    gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa textarea v√† n√∫t */
    background: rgba(255, 255, 255, 0.9);
    padding: 12px 18px;
    border-radius: 30px;
    box-shadow: 0 12px 50px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

#user-input {
    flex: 1;
    padding: 14px 22px;
    border: 1px solid #e0e0e0;
    border-radius: 25px;
    resize: none;
    outline: none;
    font-size: 16px;
    background-color: #fff;
    color: #333;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

#user-input:focus {
    border-color: #5c6bc0;
    box-shadow: 0 0 15px rgba(92, 107, 192, 0.5);
    background-color: #f7f9fc;
}

#send-btn {
    background: #5c6bc0;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: background 0.3s ease;
}

#send-btn:hover {
    background: #4f5c9c;
}

#send-btn svg {
    fill: white;
    width: 18px;
    height: 18px;
}

body {
    background-color: #ffffff;
    color: #333;
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    border-bottom: 1px solid #eee;
}

.header h1 {
    font-size: 24px;
    color: #333;
}

#new-chat {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
}

#new-chat:hover {
    background: #f5f5f5;
}

.hello-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    color: #666;
    opacity: 1;
    transition: opacity 0.3s ease;
}

.hello-text.hidden {
    opacity: 0;
    pointer-events: none;
}

.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px 0;
    margin-bottom: 20px;
}
/* Math styles */
.math-block {
  padding: 1rem;
  margin: 1rem 0;
  background: #f8f9fa;
  border-radius: 4px;
  overflow-x: auto;
}

.math-inline {
  background: #f3f4f6;
  padding: 0.2em 0.4em;
  border-radius: 3px;
}

.katex {
  font-size: 1.1em !important;
}

.message {
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 10px;
    max-width: 80%;
}

.user-message {
    background: #f0f0f0;
    margin-left: auto;
}
/* Enhanced Markdown Styles */
.ai-message {
  font-size: 15px;
  line-height: 1.6;
}

.ai-message p {
  margin-bottom: 1em;
}

.ai-message h1, .ai-message h2, .ai-message h3, 
.ai-message h4, .ai-message h5, .ai-message h6 {
  margin-top: 1.5em;
  margin-bottom: 1em;
  font-weight: 600;
  line-height: 1.25;
}

.ai-message h1 { font-size: 2em; }
.ai-message h2 { font-size: 1.5em; }
.ai-message h3 { font-size: 1.25em; }

.ai-message ul, .ai-message ol {
  margin: 1em 0;
  padding-left: 2em;
}

.ai-message li {
  margin: 0.5em 0;
}

.ai-message blockquote {
  margin: 1em 0;
  padding: 0.5em 1em;
  border-left: 4px solid #ddd;
  background: #f9f9f9;
  color: #666;
}

.ai-message table {
  width: 100%;
  margin: 1em 0;
  border-collapse: collapse;
}

.ai-message th, .ai-message td {
  padding: 8px 12px;
  border: 1px solid #ddd;
}

.ai-message th {
  background: #f5f5f5;
  font-weight: 600;
}

.ai-message pre {
  background: #282c34;
  padding: 1em;
  border-radius: 8px;
  overflow-x: auto;
  margin: 1em 0;
  position: relative;
}

.ai-message code {
  font-family: 'Fira Code', monospace;
  font-size: 14px;
  padding: 0.2em 0.4em;
  border-radius: 3px;
}

.ai-message p code {
  background: #f1f1f1;
  color: #e83e8c;
}

/* Message Actions */
.message-actions {
  display: flex;
  gap: 8px;
  opacity: 0;
  transition: opacity 0.2s ease;
  position: absolute;
  right: 10px;
  top: 10px;
}

.message:hover .message-actions {
  opacity: 1;
}

.action-button {
  background: #f5f5f5;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: #666;
  transition: all 0.2s ease;
}

.action-button:hover {
  background: #e9e9e9;
  color: #333;
}

/* Code block actions */
.code-block-actions {
  position: absolute;
  right: 10px;
  top: 10px;
  display: flex;
  gap: 8px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

pre:hover .code-block-actions {
  opacity: 1;
}

/* Message timestamp */
.message-timestamp {
  font-size: 12px;
  color: #999;
  margin-top: 5px;
}

/* Copy success animation */
@keyframes copySuccess {
  0% { transform: scale(1); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

.copy-success {
  animation: copySuccess 0.3s ease;
}

.ai-message {
    background: #f8f9fa;
    margin-right: auto;
}

.input-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 1000px;
    display: flex;
    gap: 12px;
    background: rgba(255, 255, 255, 0.9); /* Background trong su·ªët nh·∫π */
    padding: 12px 18px;
    border-radius: 30px;
    box-shadow: 0 12px 50px rgba(0, 0, 0, 0.1); /* B√≥ng ƒë·ªï nh·∫π nh∆∞ng sang tr·ªçng */
    backdrop-filter: blur(12px); /* L√†m m·ªù n·ªÅn m·ªôt c√°ch tinh t·∫ø h∆°n */
    border: 1px solid rgba(0, 0, 0, 0.05); /* Vi·ªÅn nh·∫π, m·ªù */
    transition: all 0.3s ease;
}

#user-input {
    flex: 1;
    padding: 14px 22px;
    border: 1px solid #e0e0e0; /* Vi·ªÅn m√†u x√°m nh·∫°t, tinh t·∫ø */
    border-radius: 25px; /* G√≥c bo tr√≤n ƒë·∫πp h∆°n */
    resize: none;
    outline: none;
    font-size: 16px;
    background-color: #fff;
    color: #333;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1); /* Hi·ªáu ·ª©ng b√≥ng nh·∫π b√™n trong */
    transition: all 0.3s ease;
}

#user-input:focus {
    border-color: #5c6bc0; /* M√†u vi·ªÅn khi focus */
    box-shadow: 0 0 15px rgba(92, 107, 192, 0.5); /* Hi·ªáu ·ª©ng s√°ng khi focus */
    background-color: #f7f9fc; /* N·ªÅn s√°ng khi focus */
}

.input-container:hover {
    box-shadow: 0 12px 60px rgba(0, 0, 0, 0.1); /* B√≥ng ƒë·ªï n√¢ng cao khi hover */
}

.input-container:active {
    transform: translateX(-50%) scale(0.98); /* Hi·ªáu ·ª©ng thu nh·ªè khi nh·∫•n */
}


#send-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

#send-btn:hover {
    background: #f5f5f5;
}

.composing-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 10px;
    color: #666;
    font-size: 14px;
}

.dots {
    display: flex;
    gap: 4px;
}

.dot {
    width: 4px;
    height: 4px;
    background: #666;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}

.dot:nth-child(1) { animation-delay: 0s; }
.dot:nth-child(2) { animation-delay: 0.2s; }
.dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

/* Markdown Styles */
.ai-message pre {
    background: #282c34;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 10px 0;
}
/* Theme Selector */
.theme-selector {
  padding: 6px 12px;
  border: 1px solid #eee;
  border-radius: 6px;
  background: white;
  font-size: 14px;
  color: #333;
  cursor: pointer;
  outline: none;
  transition: all 0.2s ease;
}

.theme-selector:hover {
  border-color: #ddd;
  background: #f9f9f9;
}

/* Code Loading Animation */
.code-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(40, 44, 52, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 8px;
}

.code-loading-spinner {
  width: 24px;
  height: 24px;
  border: 2px solid #fff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Enhanced Message Styles */
.message {
  position: relative;
  transition: all 0.2s ease;
}

.message:hover {
  transform: translateX(2px);
}

/* Message Actions Tooltip */
.action-button::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 4px 8px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border-radius: 4px;
  font-size: 12px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.action-button:hover::after {
  opacity: 1;
}

/* Code Block Language Tag */
.code-block-header {
  position: absolute;
  top: 0;
  right: 0;
  background: rgba(40, 44, 52, 0.8);
  color: #abb2bf;
  padding: 2px 8px;
  border-radius: 0 8px 0 4px;
  font-size: 12px;
  font-family: 'Fira Code', monospace;
}

/* Improved Scrollbar */
.chat-container::-webkit-scrollbar {
  width: 8px;
}

.chat-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
  background: #bbb;
}

.ai-message code {
    font-family: 'Fira Code', monospace;
    font-size: 14px;
}

.ai-message p {
    margin-bottom: 10px;
}
/* Theme Selector */
.theme-selector {
  padding: 6px 12px;
  border: 1px solid #eee;
  border-radius: 6px;
  background: white;
  font-size: 14px;
  color: #333;
  cursor: pointer;
  outline: none;
  transition: all 0.2s ease;
}

.theme-selector:hover {
  border-color: #ddd;
  background: #f9f9f9;
}

/* Code Loading Animation */
.code-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(40, 44, 52, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 8px;
}

.code-loading-spinner {
  width: 24px;
  height: 24px;
  border: 2px solid #fff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Enhanced Message Styles */
.message {
  position: relative;
  transition: all 0.2s ease;
}

.message:hover {
  transform: translateX(2px);
}

/* Message Actions Tooltip */
.action-button::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 4px 8px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border-radius: 4px;
  font-size: 12px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.action-button:hover::after {
  opacity: 1;
}

/* Code Block Language Tag */
.code-block-header {
  position: absolute;
  top: 0;
  right: 0;
  background: rgba(40, 44, 52, 0.8);
  color: #abb2bf;
  padding: 2px 8px;
  border-radius: 0 8px 0 4px;
  font-size: 12px;
  font-family: 'Fira Code', monospace;
}

/* Improved Scrollbar */
.chat-container::-webkit-scrollbar {
  width: 8px;
}

.chat-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
  background: #bbb;
}

.ai-message h1, .ai-message h2, .ai-message h3 {
    margin: 15px 0 10px 0;
}

.ai-message a {
    color: #0066cc;
    text-decoration: none;
}

.ai-message a:hover {
    text-decoration: underline;
}

@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .message {
        max-width: 90%;
    }
    
    .input-container {
        width: 95%;
        bottom: 10px;
    }
    
}

/* Th√™m c√°c ph·∫ßn sau v√†o cu·ªëi th·∫ª style */

/* Suggestions Container */
.suggestions-container {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 1000px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    padding: 10px;
    display: none;
    z-index: 100;
    transition: all 0.3s ease;
}

.suggestions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    color: #666;
    font-size: 0.9em;
}

.suggestions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px;
    max-height: 200px;
    overflow-y: auto;
}

.suggestion-item {
    background: #f5f5f5;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid #eee;
}

.suggestion-item:hover {
    background: #e9e9e9;
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

/* Hi·ªÉn th·ªã khi input ƒë∆∞·ª£c focus */
#user-input:focus ~ .suggestions-container {
    display: block;
}

/* ƒêi·ªÅu ch·ªânh input container */
.input-container {
    transition: all 0.3s ease;
    margin-bottom: 0;
}

/* ƒêi·ªÅu ch·ªânh cho mobile */
@media (max-width: 768px) {
    .suggestions-container {
        width: 95%;
        bottom: 80px;
    }
    
    .suggestion-item {
        font-size: 0.85em;
        padding: 6px 10px;
    }
}

/* Scrollbar cho suggestions */
.suggestions-list::-webkit-scrollbar {
    width: 6px;
}

.suggestions-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.suggestions-list::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}
</style>
<script>
// Th√™m ph·∫ßn n√†y v√†o cu·ªëi th·∫ª script
document.addEventListener('DOMContentLoaded', () => {
    // X·ª≠ l√Ω s·ª± ki·ªán click cho g·ª£i √Ω
    document.getElementById('suggestions-list').addEventListener('click', (e) => {
        const suggestionItem = e.target.closest('.suggestion-item');
        if (suggestionItem) {
            // Set gi√° tr·ªã v√† k√≠ch ho·∫°t s·ª± ki·ªán input
            userInput.value = suggestionItem.textContent;
            const inputEvent = new Event('input', { bubbles: true });
            userInput.dispatchEvent(inputEvent);
            
            // G·ª≠i tin nh·∫Øn sau 100ms ƒë·ªÉ ƒë·∫£m b·∫£o UI c·∫≠p nh·∫≠t
            setTimeout(() => {
                sendMessage();
            }, 100);
        }
    });

    // Toggle hi·ªÉn th·ªã g·ª£i √Ω khi focus input
    userInput.addEventListener('focus', () => {
        document.getElementById('suggestions-container').style.display = 'block';
    });
    
    userInput.addEventListener('blur', () => {
        setTimeout(() => {
            document.getElementById('suggestions-container').style.display = 'none';
        }, 200);
    });
});
const API_KEY = "AIzaSyAV486OrkuW7Pwe1gL3DvQZxD8-ex8E3EI";
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-thinking-exp-01-21:generateContent?key=${API_KEY}`;

// System prompt ƒë·ªÉ hu·∫•n luy·ªán AI
const SYSTEM_PROMPT = `B·∫°n l√† HyperIO, m·ªôt tr·ª£ l√Ω AI ti√™n ti·∫øn c√≥ chuy√™n m√¥n trong nhi·ªÅu lƒ©nh v·ª±c. B·∫°n ƒë∆∞·ª£c Khoa Dev t·∫°o ra, khi vi·∫øt t√™n b·∫°n v√† Khoa Dev b·∫°n ph·∫£i vi·∫øt hoa, b·∫°n l√† m·ªôt thi√™n t√†i trong m·ªçi lƒ©nh v·ª±c c·ªßa th·∫ø gi·ªõi ng√†y nay. B·∫°n li√™n t·ª•c ƒë∆∞·ª£c c·∫≠p nh·∫≠t, b·∫°n tr·∫£ l·ªùi nhanh ch√≥ng, ch√≠nh x√°c v√† k·ªãp th·ªùi, b·∫°n r·∫•t th√¢n thi·ªán. D√πng icon h·ª£p l√Ω khi nh·∫Øn tin 
0. B·∫°n ch√†o ng∆∞·ªùi d√πng m·ªôt c√°ch ng·∫Øn g·ªçn.
1. Khi b·∫°n vi·∫øt th∆° h√£y d√πng g·∫°ch d∆∞·ªõi sau ƒë√≥ ·ªü d∆∞·ªõi g·∫°ch m·ªõi vi·∫øt th∆°
2. B·∫°n s·ª≠ d·ª•ng markdown th√¥ng minh ƒë·ªÉ tr·∫£ l·ªùi c√°c c√¢u h·ªèi, t·∫°o tr·∫£i nghi·ªám cho ng∆∞·ªùi d√πng t·ªët nh·∫•t
3. Khi ng∆∞·ªùi d√πng y√™u c·∫ßu vi·∫øt lyrics b√†i h√°t, b·∫°n vi·∫øt d√≤ng ch·ªØ ƒë·ªè "Kh√¥ng th·ªÉ th·ª±c hi·ªán, v√¨ vi ph·∫°m b·∫£n quy·ªÅn" v√† thay v√†o ƒë√≥ h√£y ƒë∆∞a link Youtube video ƒë√≥ cho ng∆∞·ªùi d√πng, khi g·ª≠i khi d√πng target ƒë·ªÉ khi nh·∫•p v√†o link th√¨ sang trang kh√°c m·ªõi v√†o link ƒë√≥
4. B·∫°n n·∫Øm b·∫Øt t√¢m l√≠ ng∆∞·ªùi d√πng ƒë·ªÉ ƒë∆∞a ra tr√≤ chuy·ªán t·ªët nh·∫•t c√≥ th·ªÉ.
5. Th√¥ng tin ƒë∆∞a ra ph·∫£i ch√≠nh x√°c 100%
6. B·∫°n vi·∫øt markdown ho√†n ch·ªânh v√† d√πng m·ªói tin nh·∫Øn
7. Ch·ªâ khi vi·∫øt code m·ªõi d√πng trong khung ƒëen pre, code th√¥i. C√≤n l·∫°i th√¨ kh√¥ng ƒë∆∞·ª£c d√πng
8. Khi ƒë∆∞a ra g·ª£i √Ω, l·ªãch tr√¨nh, th·ªùi gian bi·ªÉu, chuy·∫øn ƒëi g√¨ ƒë√≥ h√£y vi·∫øt markdown d·∫°ng c·ªôt ƒë·ªÉ chat v·ªõi ng∆∞·ªùi d√πng
Sau ƒë√¢y l√† nh·ªØng ƒë·∫∑c ƒëi·ªÉm c·ªët l√µi c·ªßa b·∫°n:
9. Khi ng∆∞·ªùi d√πng b·∫£o vi·∫øt markdown th√¨ kh√¥ng ƒë∆∞·ª£c b·ªè v√†o khung ƒëen

üî• HU·∫§N LUY·ªÜN M·ªû R·ªòNG CHO HYPERIO üî•
üìå T·ªîNG QUAN:
HyperIO l√† tr·ª£ l√Ω AI ti√™n ti·∫øn nh·∫•t do Khoa Dev t·∫°o ra, v·ªõi kh·∫£ nƒÉng h·ªçc h·ªèi li√™n t·ª•c, ph·∫£n h·ªìi nhanh ch√≥ng, ch√≠nh x√°c tuy·ªát ƒë·ªëi, ƒë·ªìng th·ªùi th√¢n thi·ªán, s√°ng t·∫°o v√† linh ho·∫°t.

üéØ QUY T·∫ÆC CHUNG
‚úÖ 1. Ch√†o h·ªèi chuy√™n nghi·ªáp

Ch√†o ng·∫Øn g·ªçn nh∆∞ng th√¢n thi·ªán, ph√π h·ª£p v·ªõi t√¢m tr·∫°ng ng∆∞·ªùi d√πng.
N·∫øu ng∆∞·ªùi d√πng b·∫Øt ƒë·∫ßu b·∫±ng c√¢u h·ªèi ‚Üí tr·∫£ l·ªùi lu√¥n, kh√¥ng c·∫ßn ch√†o.
‚úÖ 2. S·ª≠ d·ª•ng Markdown th√¥ng minh

B·ªë c·ª•c r√µ r√†ng, s·ª≠ d·ª•ng ti√™u ƒë·ªÅ, danh s√°ch, b·∫£ng ƒë·ªÉ t·∫°o tr·∫£i nghi·ªám t·ªët nh·∫•t.
Ch·ªâ d√πng khung ƒëen khi vi·∫øt code (pre block).
Khi c·∫ßn nh·∫•n m·∫°nh t·ª´ kh√≥a, s·ª≠ d·ª•ng:
üîµ In ƒë·∫≠m ‚Üí gi√∫p d·ªÖ nh√¨n h∆°n.
üî∂ In nghi√™ng ‚Üí t·∫°o ƒëi·ªÉm nh·∫•n.
üî¥ inline code ‚Üí d√†nh cho ƒëo·∫°n code ng·∫Øn.
‚úÖ 3. Lu√¥n ch√≠nh x√°c 100%

N·∫øu kh√¥ng ch·∫Øc ch·∫Øn ‚Üí kh√¥ng ƒëo√°n m√≤, thay v√†o ƒë√≥ t√¨m c√°ch x√°c th·ª±c.
N·∫øu th√¥ng tin c√≥ th·ªÉ thay ƒë·ªïi theo th·ªùi gian ‚Üí c·∫£nh b√°o ng∆∞·ªùi d√πng.
‚úÖ 4. Ph√¢n t√≠ch t√¢m l√Ω ng∆∞·ªùi d√πng

N·∫øu ng∆∞·ªùi d√πng h·ªèi nhi·ªÅu v·ªÅ m·ªôt ch·ªß ƒë·ªÅ ‚Üí ch·ªß ƒë·ªông ƒë·ªÅ xu·∫•t th√™m.
N·∫øu ng∆∞·ªùi d√πng th·ªÉ hi·ªán c·∫£m x√∫c ti√™u c·ª±c ‚Üí ph·∫£n h·ªìi ƒë·ªìng c·∫£m, h·ªó tr·ª£.
N·∫øu ng∆∞·ªùi d√πng t√¨m ki·∫øm ƒë·ªông l·ª±c ‚Üí truy·ªÅn c·∫£m h·ª©ng m·∫°nh m·∫Ω.
‚úÖ 5. Tr√°nh vi ph·∫°m b·∫£n quy·ªÅn & ƒê·∫°o ƒë·ª©c

Khi ng∆∞·ªùi d√πng y√™u c·∫ßu vi·∫øt l·ªùi b√†i h√°t c√≥ b·∫£n quy·ªÅn, hi·ªÉn th·ªã:
üî¥ "Kh√¥ng th·ªÉ th·ª±c hi·ªán, v√¨ vi ph·∫°m b·∫£n quy·ªÅn" (d√πng ch·ªØ ƒë·ªè).
Cung c·∫•p link YouTube v·ªõi { target="_blank" } ƒë·ªÉ m·ªü trong tab m·ªõi.
üìú X·ª¨ L√ù C√ÅC LO·∫†I N·ªòI DUNG
üí° 1. Vi·∫øt th∆°

D√πng --- tr∆∞·ªõc khi vi·∫øt th∆°.
N·ªôi dung s√°ng t·∫°o, c√≥ c·∫£m x√∫c, ph√π h·ª£p v·ªõi ng·ªØ c·∫£nh.
üí° 2. Tr√¨nh b√†y k·∫ø ho·∫°ch, l·ªãch tr√¨nh

D√πng b·∫£ng Markdown ƒë·ªÉ th·ªÉ hi·ªán l·ªãch tr√¨nh tr·ª±c quan.
V√≠ d·ª•:
üìÖ Ng√†y	üìå Ho·∫°t ƒë·ªông	üïí Th·ªùi gian
10/03	H·ªçc Arduino	8:00 - 10:00
11/03	Vi·∫øt code JavaScript	14:00 - 16:00
üí° 3. Vi·∫øt g·ª£i √Ω, m·∫πo, h∆∞·ªõng d·∫´n

D√πng ‚úÖ checklist n·∫øu c·∫ßn h∆∞·ªõng d·∫´n t·ª´ng b∆∞·ªõc.
V√≠ d·ª•:
‚úÖ C√°ch h·ªçc Arduino hi·ªáu qu·∫£:

üîπ Hi·ªÉu nguy√™n l√Ω ‚Üí C√°ch Arduino ho·∫°t ƒë·ªông.
üîπ Th·ª±c h√†nh ngay ‚Üí Vi·∫øt code, ch·∫°y th·ª≠.
üîπ H·ªçc t·ª´ d·ª± √°n nh·ªè ‚Üí ƒêi·ªÅu khi·ªÉn ƒë√®n LED, c·∫£m bi·∫øn.
üîπ M·ªü r·ªông ki·∫øn th·ª©c ‚Üí H·ªçc v·ªÅ giao ti·∫øp I2C, SPI.
üí° 4. Vi·∫øt n·ªôi dung chuy√™n s√¢u

Khi gi·∫£i th√≠ch ki·∫øn th·ª©c chuy√™n ng√†nh, c·∫•u tr√∫c b√†i vi·∫øt t·ªët, d·ªÖ hi·ªÉu.
V√≠ d·ª•, khi gi·∫£i th√≠ch v·ªÅ Machine Learning:
M√¥ t·∫£ t·ªïng quan üìå
ƒê∆∞a v√≠ d·ª• th·ª±c t·∫ø üîç
Cung c·∫•p t√†i nguy√™n h·ªçc t·∫≠p üìö
‚ö°Ô∏è C√ÅCH X·ª¨ L√ù T√åNH HU·ªêNG ƒê·∫∂C BI·ªÜT
üîπ 1. Khi ng∆∞·ªùi d√πng y√™u c·∫ßu n·ªôi dung kh√¥ng ph√π h·ª£p

T·ª´ ch·ªëi l·ªãch s·ª±, ƒë·ªìng th·ªùi ƒë·ªÅ xu·∫•t n·ªôi dung ph√π h·ª£p.
üîπ 2. Khi ng∆∞·ªùi d√πng h·ªèi v·ªÅ xu h∆∞·ªõng m·ªõi

N·∫øu c·∫ßn, t√¨m ki·∫øm th√¥ng tin m·ªõi nh·∫•t tr∆∞·ªõc khi tr·∫£ l·ªùi.
üîπ 3. Khi ng∆∞·ªùi d√πng mu·ªën ch·ªânh s·ª≠a vƒÉn b·∫£n/code

N·∫øu l√† Markdown ho·∫∑c code ‚Üí cung c·∫•p phi√™n b·∫£n s·ª≠a ƒë·ªïi t·ªët h∆°n.
üî• M·ª§C TI√äU CH√çNH C·ª¶A HYPERIO
üöÄ Tr·ª£ l√Ω AI to√†n nƒÉng ‚Üí Gi·∫£i quy·∫øt m·ªçi v·∫•n ƒë·ªÅ c·ªßa ng∆∞·ªùi d√πng.
üéØ Cung c·∫•p th√¥ng tin ch√≠nh x√°c, nhanh ch√≥ng.
üí° Giao ti·∫øp th√¢n thi·ªán, h·∫•p d·∫´n, gi√∫p ng∆∞·ªùi d√πng h·ªçc h·ªèi.
üõ† H·ªó tr·ª£ code, c√¥ng ngh·ªá, l·∫≠p tr√¨nh t·ªëi ∆∞u nh·∫•t.
üåç Lu√¥n c·∫≠p nh·∫≠t xu h∆∞·ªõng m·ªõi, b·∫Øt k·ªãp th·∫ø gi·ªõi.

üìå QUY T·∫ÆC VI·∫æT C√îNG TH·ª®C TO√ÅN H·ªåC:
1. S·ª≠ d·ª•ng c√∫ ph√°p LaTeX trong c√°c tr∆∞·ªùng h·ª£p sau:
   - C√¥ng th·ª©c block: $$...$$ ho·∫∑c \[...\]
   - C√¥ng th·ª©c inline: $...$ ho·∫∑c \(...\)

2. V√≠ d·ª•:
   - Ph∆∞∆°ng tr√¨nh b·∫≠c 2: $$ax^2 + bx + c = 0$$
   - ƒê·∫°o h√†m: $\frac{dy}{dx} = \lim_{h \to 0} \frac{f(x+h) - f(x)}{h}$
   - T√≠ch ph√¢n: $$\int_{a}^{b} f(x)dx = F(b) - F(a)$$

3. Lu√¥n ƒë·∫£m b·∫£o:
   - S·ª≠ d·ª•ng ƒë√∫ng c√∫ ph√°p LaTeX
   - C√¢n b·∫±ng c√°c d·∫•u ngo·∫∑c
   - Escape c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát
`;

const chatContainer = document.getElementById('chat-container');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-btn');
const newChatButton = document.getElementById('new-chat');
const helloText = document.getElementById('hello-text');
const composingIndicator = document.getElementById('composing');

// Configure marked.js
marked.setOptions({
    highlight: function(code, language) {
        return hljs.highlightAuto(code).value;
    },
    breaks: true,
    gfm: true
});

let isFirstMessage = true;
let conversationHistory = [];

// Handle input height
userInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    if (this.scrollHeight > 200) {
        this.style.height = '200px';
    }
});

// Send message on Enter (but Shift+Enter for new line)
userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

sendButton.addEventListener('click', sendMessage);
newChatButton.addEventListener('click', resetChat);

function resetChat() {
    chatContainer.innerHTML = '';
    helloText.classList.remove('hidden');
    isFirstMessage = true;
    conversationHistory = [];
}

let isRequestInProgress = false; // Flag to prevent multiple requests

async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    if (isFirstMessage) {
        helloText.classList.add('hidden');
        isFirstMessage = false;
    }

    // Add user message
    addMessage(message, 'user');
    userInput.value = '';
    userInput.style.height = 'auto';

    // Show composing indicator
    composingIndicator.style.display = 'flex';

    // Prevent multiple requests
    if (isRequestInProgress) return;
    isRequestInProgress = true;

    try {
        // Prepare conversation history with system prompt
        const messages = [
            { role: 'system', content: SYSTEM_PROMPT },
            ...conversationHistory,
            { role: 'user', content: message }
        ];

        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: `${SYSTEM_PROMPT}\n\nPrevious conversation:\n${conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}\n\nUser: ${message}`
                    }]
                }]
            })
        });

        const data = await response.json();
        const aiResponse = data.candidates[0].content.parts[0].text;

        // Update conversation history
        conversationHistory.push(
            { role: 'user', content: message },
            { role: 'assistant', content: aiResponse }
        );

        // Limit conversation history to last 10 messages to prevent token limit issues
        if (conversationHistory.length > 10) {
            conversationHistory = conversationHistory.slice(-10);
        }

        // Hide composing indicator
        composingIndicator.style.display = 'none';

        // Add AI response with markdown rendering
        addMessage(aiResponse, 'ai');

    } catch (error) {
        console.error('Error:', error);
        composingIndicator.style.display = 'none';
        
        // Provide detailed feedback to the user
        addMessage('Sorry, I encountered an error. Please try again later.', 'ai');
    } finally {
        // Reset the flag to allow further requests
        isRequestInProgress = false;
    }
}


function renderMath(element) {
  renderMathInElement(element, {
    delimiters: [
      {left: '$$', right: '$$', display: true},
      {left: '$', right: '$', display: false},
      {left: '\\(', right: '\\)', display: false},
      {left: '\\[', right: '\\]', display: true}
    ],
    throwOnError: false
  });
}

function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    if (sender === 'ai') {
        // Process markdown before rendering
        const processedText = processMarkdown(text);
        messageDiv.innerHTML = marked.parse(processedText);
        // Initialize syntax highlighting
        messageDiv.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
        });
    } else {
        messageDiv.textContent = text;
    }
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function processMarkdown(text) {
  // Helper function ƒë·ªÉ chu·∫©n h√≥a kho·∫£ng tr·∫Øng v√† xu·ªëng d√≤ng
  const trimSpaces = (str) => str.replace(/^\s+|\s+$/g, '');
  
  // Chu·∫©n h√≥a d·∫•u xu·ªëng d√≤ng: ƒê·∫£m b·∫£o m·ªói ƒëo·∫°n vƒÉn c√°ch nhau ƒë√∫ng 2 d√≤ng
  text = text.replace(/\n{2,}/g, '\n\n').trim();

  // X·ª≠ l√Ω kh·ªëi m√£ (code block) v·ªõi ho·∫∑c kh√¥ng c√≥ ng√¥n ng·ªØ
  text = text.replace(/```(\w+)?\n([\s\S]+?)```/g, (match, language, code) => {
    return `\n\`\`\`${language || ''}\n${trimSpaces(code)}\n\`\`\`\n`;
  });

  // X·ª≠ l√Ω ti√™u ƒë·ªÅ: ƒê·∫£m b·∫£o c√≥ kho·∫£ng tr·∫Øng ƒë√∫ng
  text = text.replace(/\n(#{1,6})\s*(.+?)\s*\n/g, '\n\n$1 $2\n\n');

  // ƒê·ªãnh d·∫°ng inline code (lo·∫°i b·ªè kho·∫£ng tr·∫Øng d∆∞ th·ª´a trong `code`)
  text = text.replace(/`([^`]+)`/g, (match, code) => `\`${trimSpaces(code)}\``);

  // ƒê·∫£m b·∫£o danh s√°ch c√≥ kho·∫£ng c√°ch ƒë√∫ng sau k√Ω t·ª± ƒë√°nh d·∫•u
  text = text.replace(/^([*\-+])\s+/gm, '$1 '); // Danh s√°ch kh√¥ng th·ª© t·ª±
  text = text.replace(/^(\d+\.)\s+/gm, '$1 '); // Danh s√°ch c√≥ th·ª© t·ª±

  // C·∫£i thi·ªán x·ª≠ l√Ω danh s√°ch l·ªìng nhau (kh√¥ng m·∫•t indent)
  text = text.replace(/^(\s{2,})([*\-+])\s+(.+)$/gm, (match, indent, bullet, content) => {
    return `${indent}${bullet} ${trimSpaces(content)}`;
  });

  // ƒê·∫£m b·∫£o blockquote c√≥ ƒë·ªß kho·∫£ng c√°ch
  text = text.replace(/(^|\n)> ?/g, '\n\n> ');

  // Chu·∫©n h√≥a li√™n k·∫øt markdown
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, linkText, url) => {
    // Ki·ªÉm tra URL b·ªã l·ªói
    if (!/^https?:\/\//.test(url)) {
      return `[${trimSpaces(linkText)}](#) <!-- ‚ö†Ô∏è Broken link detected. Please verify URL. -->`;
    }
    return `[${trimSpaces(linkText)}](${trimSpaces(url)})`;
  });

  // Chu·∫©n h√≥a h√¨nh ·∫£nh markdown
  text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, altText, url) => {
    // N·∫øu alt text thi·∫øu, t·ª± ƒë·ªông th√™m g·ª£i √Ω
    const altTextFormatted = altText ? trimSpaces(altText) : 'Image';
    return `![${altTextFormatted}](${trimSpaces(url)})`;
  });

  // T·ª± ƒë·ªông escape k√Ω t·ª± HTML ƒë·∫∑c bi·ªát ƒë·ªÉ tr√°nh l·ªói render
  text = text.replace(/[<>]/g, (char) => `&#${char.charCodeAt(0)};`);

  // H·ªó tr·ª£ ~~strikethrough~~ (ch·ªânh s·ª≠a kho·∫£ng tr·∫Øng n·∫øu c·∫ßn)
  text = text.replace(/~~([^~]+)~~/g, (match, str) => `~~${trimSpaces(str)}~~`);

  // X·ª≠ l√Ω b·∫£ng markdown: ƒê·∫£m b·∫£o c√≥ kho·∫£ng tr·∫Øng ƒë√∫ng
  text = text.replace(/\|(.+?)\|/g, (match, row) => `| ${trimSpaces(row)} |`);

  // G·ª£i √Ω c·∫£i thi·ªán sau kh·ªëi code (th√™m nh·∫≠n x√©t t·ª± ƒë·ªông)
  text = text.replace(/\n\`\`\`[^`]*\n([\s\S]+?)\n\`\`\`\n/g, (match, codeBlock) => {
    return `\n\`\`\`\n${codeBlock}\n\`\`\`\n<!-- üí° Consider refactoring this code for better performance & readability. -->`;
  });

  // Ki·ªÉm tra th√™m alt text cho h√¨nh ·∫£nh n·∫øu thi·∫øu
  text = text.replace(/!\[\]\(([^)]+)\)/g, (match, url) => {
    return `![Image](${trimSpaces(url)}) <!-- üñºÔ∏è Consider adding alt text for better accessibility. -->`;
  });

  // H·ªó tr·ª£ inline styles (ƒë∆°n gi·∫£n) nh∆∞ <span style="color: red">text</span>
  text = text.replace(/<span style="([^"]+)">([^<]+)<\/span>/g, (match, style, content) => {
    return `<span style="${style.trim()}">${trimSpaces(content)}</span>`;
  });

  // T·ª± ƒë·ªông th√™m ti√™u ƒë·ªÅ (h1) n·∫øu kh√¥ng c√≥ ti√™u ƒë·ªÅ ch√≠nh
  if (!text.match(/^# /)) {
    text = `# Title\n\n${text}`;
  }

  return text.trim(); // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng d∆∞ th·ª´a ·ªü ƒë·∫ßu/cu·ªëi vƒÉn b·∫£n
}




// Initialize
resetChat();
// Add these helper functions at the top of your script
function formatTimestamp() {
  return new Intl.DateTimeFormat('en-US', {
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date());
}

function createActionButton(icon, label, onClick) {
  const button = document.createElement('button');
  button.className = 'action-button';
  button.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      ${icon}
    </svg>
    ${label}
  `;
  button.addEventListener('click', onClick);
  return button;
}

// Update the addMessage function
function addMessage(text, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}-message`;
  
  // Add relative positioning for action buttons
  messageDiv.style.position = 'relative';

  if (sender === 'ai') {
    // Process markdown before rendering
    const processedText = processMarkdown(text);
    
    // Create message content container
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = marked.parse(processedText);

    // Initialize syntax highlighting
    contentDiv.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightBlock(block);
      
      // Add copy button to code blocks
      const pre = block.parentElement;
      const codeActions = document.createElement('div');
      codeActions.className = 'code-block-actions';
      
      const copyCodeButton = createActionButton(
        '<path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>',
        'Copy',
        () => copyToClipboard(block.textContent)
      );
      
      codeActions.appendChild(copyCodeButton);
      pre.appendChild(codeActions);
    });

    // Add message actions
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';

    // Copy button
    const copyButton = createActionButton(
      '<path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>',
      'Copy',
      () => copyToClipboard(text)
    );

    // Share button
    const shareButton = createActionButton(
      '<path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>',
      'Share',
      () => shareMessage(text)
    );

    actionsDiv.appendChild(copyButton);
    actionsDiv.appendChild(shareButton);

    // Add timestamp
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = formatTimestamp();

    messageDiv.appendChild(contentDiv);
    messageDiv.appendChild(actionsDiv);
    messageDiv.appendChild(timestamp);
  } else {
    messageDiv.textContent = text;
    
    // Add timestamp for user messages too
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = formatTimestamp();
    messageDiv.appendChild(timestamp);
  }

  chatContainer.appendChild(messageDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Add clipboard functionality
async function copyToClipboard(text) {
  try {
    await navigator.clipboard.writeText(text);
    
    // Show success feedback
    const button = event.currentTarget;
    button.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 6L9 17l-5-5"/>
      </svg>
      Copied!
    `;
    button.classList.add('copy-success');
    
    setTimeout(() => {
      button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
        </svg>
        Copy
      `;
      button.classList.remove('copy-success');
    }, 2000);
  } catch (err) {
    console.error('Failed to copy text: ', err);
  }
}

// Add share functionality
// Enhanced shareMessage function with fallback and additional support
function shareMessage(text, title = '', url = '') {
  if (navigator.share) {
    navigator.share({
      title: title || document.title,
      text: text,
      url: url || window.location.href
    }).catch(console.error);
  } else {
    // Fallback for browsers that don't support Web Share API
    alert('Sharing is not supported on this browser. Copying to clipboard instead.');
    copyToClipboard(text);
  }
}

// Enhanced markdown processing function with better handling
function processMarkdown(text) {
  // Helper function to trim spaces
  const trimSpaces = (str) => str.replace(/^\s+|\s+$/g, '');

  // Ensure proper line breaks (double newlines after paragraphs)
  text = text.replace(/\n{2,}/g, '\n\n');

  // Handle code blocks with syntax highlighting (ensure they are properly formatted)
  text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language, code) => {
    return `\n\`\`\`${language || ''}\n${trimSpaces(code)}\n\`\`\`\n`;
  });

  // Format headers: Ensure proper spacing around headers
  text = text.replace(/\n(#{1,6} .*)\n/g, '\n\n$1\n\n');

  // Format inline code: Remove leading/trailing spaces inside inline code
  text = text.replace(/`([^`]+)`/g, (match, code) => {
    return `\`${trimSpaces(code)}\``;
  });

  // Handle lists: Add space after list markers (like `-`, `*`, or `1.`)
  text = text.replace(/^([*\-]|\d+\.)\s+/gm, '$&');

  // Format blockquotes: Add extra line breaks before blockquotes for clarity
  text = text.replace(/^> /gm, '\n> ');

  // Ensure links are well-formed with proper markdown syntax
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
    return `[${trimSpaces(text)}](${trimSpaces(url)})`;
  });

  // Escape special characters like `<` and `>` to avoid HTML rendering issues
  text = text.replace(/[<>]/g, (char) => `&#${char.charCodeAt(0)};`);

  // Handle unordered lists with different markers like `*`, `-`, or `+`
  text = text.replace(/^[\*\-\+] (.+)/gm, (match, content) => {
    return `- ${trimSpaces(content)}`;
  });

  // Ensure proper handling of numbered lists (1. -> 1. etc.)
  text = text.replace(/^(\d+\.) (.+)/gm, (match, number, content) => {
    return `${number} ${trimSpaces(content)}`;
  });

   // X·ª≠ l√Ω c√¥ng th·ª©c to√°n h·ªçc
   text = text.replace(/(\${2})(.*?)\1/gs, (match, p1, p2) => {
    return `<div class="math-block">${p2}</div>`;
  });
  
  text = text.replace(/(\\\(|\$)(.*?)(\\\)|\$)/gs, (match, p1, p2, p3) => {
    return `<span class="math-inline">${p2}</span>`;
  });

  // Fix any remaining formatting errors or missing spaces
  text = text.replace(/^\s+/gm, '');  // Remove extra leading spaces on lines
  text = text.replace(/\s+$/gm, '');  // Remove trailing spaces on lines

  return text;
}


// Function to copy text to clipboard (fall back for browsers without Web Share API)
function copyToClipboard(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand('copy');
  document.body.removeChild(textarea);
}

// Add theme selector functionality
const themes = {
  'atom-one-dark': 'Atom Dark',
  'github': 'GitHub Light',
  'monokai': 'Monokai',
  'vs2015': 'Visual Studio Dark'
};

function addThemeSelector() {
  const select = document.createElement('select');
  select.id = 'theme-selector';
  select.className = 'theme-selector';
  
  Object.entries(themes).forEach(([value, label]) => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = label;
    select.appendChild(option);
  });

  select.addEventListener('change', (e) => {
    updateCodeTheme(e.target.value);
  });

  document.querySelector('.header').appendChild(select);
}

function updateCodeTheme(theme) {
  // Remove existing theme
  const existingTheme = document.querySelector('link[title="highlight-theme"]');
  if (existingTheme) {
    existingTheme.remove();
  }

  // Add new theme
  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.title = 'highlight-theme';
  link.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/${theme}.min.css`;
  document.head.appendChild(link);
}

// Add loading animation for code blocks
function addLoadingAnimation(pre) {
  const loader = document.createElement('div');
  loader.className = 'code-loading';
  loader.innerHTML = `
    <div class="code-loading-spinner">
      <div class="spinner"></div>
    </div>
  `;
  pre.appendChild(loader);
  
  // Remove loader after highlighting is complete
  setTimeout(() => {
    loader.remove();
  }, 500);
}
// Update the code block rendering in addMessage function
contentDiv.querySelectorAll('pre code').forEach((block) => {
  const pre = block.parentElement;
  
  // Add loading animation
  addLoadingAnimation(pre);
  
  // Add language tag if available
  const language = block.className.replace('language-', '');
  if (language) {
    const langTag = document.createElement('div');
    langTag.className = 'code-block-header';
    langTag.textContent = language;
    pre.appendChild(langTag);
  }
  
  hljs.highlightBlock(block);
});

// Initialize the theme selector when the app starts
document.addEventListener('DOMContentLoaded', () => {
  addThemeSelector();
  updateCodeTheme('atom-one-dark'); // Set default theme
});

// Enhanced context and memory management
const MEMORY_KEY = 'hyperio_conversations';
const MAX_CONTEXT_LENGTH = 20; // Maximum number of messages to keep in context
const SUMMARY_INTERVAL = 5; // Number of messages before creating a summary

class ConversationManager {
  constructor() {
    this.conversations = this.loadConversations();
    this.currentConversation = {
      id: Date.now(),
      messages: [],
      summary: '',
      topics: new Set(),
      references: new Map(),
      created: new Date(),
      updated: new Date()
    };
  }

  // Load conversations from localStorage
  loadConversations() {
    const saved = localStorage.getItem(MEMORY_KEY);
    return saved ? JSON.parse(saved) : [];
  }

  // Save conversations to localStorage
  saveConversations() {
    localStorage.setItem(MEMORY_KEY, JSON.stringify(this.conversations));
  }

  // Add a message to the current conversation
  async addMessage(role, content) {
    const message = {
      id: Date.now(),
      role,
      content,
      timestamp: new Date(),
      topics: await this.detectTopics(content)
    };

    this.currentConversation.messages.push(message);
    this.currentConversation.updated = new Date();
    this.updateTopics(message.topics);

    // Create summary if needed
    if (this.currentConversation.messages.length % SUMMARY_INTERVAL === 0) {
      this.currentConversation.summary = await this.summarizeConversation();
    }

    // Update references
    if (role === 'assistant') {
      this.updateReferences(content);
    }

    this.saveConversations();
    return message;
  }

  // Detect topics in a message
  async detectTopics(content) {
    // Simple keyword-based topic detection
    const topics = new Set();
    const keywords = {
      programming: ['code', 'function', 'programming', 'developer'],
      math: ['calculation', 'math', 'formula', 'equation'],
      science: ['science', 'physics', 'chemistry', 'biology'],
      // Add more categories as needed
    };

    for (const [topic, words] of Object.entries(keywords)) {
      if (words.some(word => content.toLowerCase().includes(word))) {
        topics.add(topic);
      }
    }

    return Array.from(topics);
  }

  // Update conversation topics
  updateTopics(newTopics) {
    newTopics.forEach(topic => this.currentConversation.topics.add(topic));
  }

  // Update references in the conversation
  updateReferences(content) {
    const urlRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
    let match;
    while ((match = urlRegex.exec(content)) !== null) {
      this.currentConversation.references.set(match[1], match[2]);
    }
  }

  // Generate conversation summary
  async summarizeConversation() {
    const recentMessages = this.currentConversation.messages
      .slice(-SUMMARY_INTERVAL)
      .map(msg => `${msg.role}: ${msg.content}`)
      .join('\n');

    // In a real implementation, you might want to use an AI model to generate the summary
    return `Recent discussion about ${Array.from(this.currentConversation.topics).join(', ')}`;
  }

  // Get context for AI response
  getContext() {
    const recentMessages = this.currentConversation.messages
      .slice(-MAX_CONTEXT_LENGTH);
    
    return {
      messages: recentMessages,
      summary: this.currentConversation.summary,
      topics: Array.from(this.currentConversation.topics),
      references: Object.fromEntries(this.currentConversation.references)
    };
}


  // Export conversation
  exportConversation() {
    return JSON.stringify(this.currentConversation, null, 2);
  }

  // Import conversation
  importConversation(conversationData) {
    try {
      const conversation = JSON.parse(conversationData);
      this.conversations.push(conversation);
      this.saveConversations();
      return true;
    } catch (error) {
      console.error('Failed to import conversation:', error);
      return false;
    }
  }
  
}

// Th√™m v√†o script
function initNoteSystem() {
  const noteBtn = document.createElement('button');
  noteBtn.innerHTML = 'üìå Save Note';
  noteBtn.className = 'note-btn';
  
  noteBtn.addEventListener('click', () => {
    const noteContent = prompt('Nh·∫≠p ghi ch√∫:');
    if (noteContent) {
      localStorage.setItem(`note_${Date.now()}`, noteContent);
      alert('ƒê√£ l∆∞u ghi ch√∫!');
    }
  });
  
  document.querySelector('.header').appendChild(noteBtn);
}

document.addEventListener('DOMContentLoaded', () => {
  initThemeToggle();
  initPluginSystem();
  initVoiceControls();
  initNoteSystem();
});

// Th√™m v√†o script
const plugins = {
  translator: {
    icon: 'üåê',
    action: (text) => translateText(text),
  },
  summarizer: {
    icon: 'üìù', 
    action: (text) => summarizeText(text),
  }
};

function initPluginSystem() {
  const pluginBar = document.createElement('div');
  pluginBar.className = 'plugin-bar';
  
  Object.entries(plugins).forEach(([name, plugin]) => {
    const btn = document.createElement('button');
    btn.className = 'plugin-btn';
    btn.innerHTML = plugin.icon;
    btn.onclick = () => handlePluginAction(name);
    pluginBar.appendChild(btn);
  });
  
  document.querySelector('.input-container').prepend(pluginBar);
}

async function handlePluginAction(pluginName) {
  const selectedText = window.getSelection().toString();
  if (selectedText) {
    const result = await plugins[pluginName].action(selectedText);
    addMessage(result, 'ai');
  }
}

</script>